@page "/courses/{CourseId:int}/{LessonId:int}/{QuizId:int}"
@page "/quiz/{QuizId:int}"

@using Blazorise
@using SEIIApp.Shared.DomainDTOs

@inject HttpClient Http
@inject NavigationManager NavigationManager

<head>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">

    <link rel="stylesheet" href="../css/StylesheetJimmaNeo.css">
</head>

<center>

    @if (quizzes == null)
    {
        <h1>Loading Quiz...</h1>
    }

    else
    {

        if (!startedQuiz)
        {

            <h1>Quiz: @quiz.Title</h1>

            <br /> <br />

            @if (inFinishedQuizzes)
            {
                <h4>You have already completed this Quiz successfully</h4>
            }
            else
            {
                <h4>You have not successfully completed this Quiz yet</h4>
            }

            <br /> <br />

            <h4>Number of questions: @questions.Length</h4>

            <br /> <br />

            <p><button class="startQuizButton" @onclick="@(() => startQuiz())">Start Quiz</button></p>

            <br /> <br />
        }
        else
        {

            if (!finishedQuiz)
            {

                <h7>@(qCounter + 1)/@questions.Length</h7>

                <Progress>
                    <ProgressBar Background="Background.Success" Value="@progress" Animated=true />
                    <ProgressBar Background="Background.Secondary" Value=@(100 - progress) Animated=true />
                </Progress>

                <br /> <br />

                <h1>Question @(qCounter + 1): @questions[qCounter].Text</h1>

                <br /> <br />

            


                       <center>
                           <ul class="list">

                               @foreach (var answer in @questions[qCounter].answers)
                               {

                                   <li class="list-item">
                                       <div class="list-content">
                                           <button class="@answer.Color" @onclick="@(() => questions[qCounter].anythingSelected(answer) )">@answer.Text</button>
                                       </div>
                                   </li>

                               }

                           </ul>

                       </center>


                <p>
                    <h7 class="@expStatus"><b>You have just earned 10 EXP</b></h7>
                </p>

                <button class="@questions[qCounter].check.Color" @onclick="@(() => checkMe(questions[qCounter]) )">@questions[qCounter].check.Text</button>

                
                <br /> <br /> 

            }
            else
            {

                bool everythingCorrect = true;

                foreach (bool b in results)
                {
                    if (b == false)
                    {
                        everythingCorrect = false;
                    }
                }

                if (everythingCorrect)
                {
                    <h2> Congratulations! You have successfully completed this Quiz.</h2>

                    saveFinishedQuizToStudent();

                }
                else
                {
                    <h2>You didn't successfully complete this Quiz. Try better next time.</h2>
                }

                <br /> <br />

                <h3>Your Results for Quiz: @quiz.Title</h3>
                <h5>Tap on an individual result to view details</h5>

                <br /> <br />


                for (int i = 0; i < results.Length; i++)
                {
                    if (results[i] == true)
                    {


                        <section class="accordion">
                            <input type="checkbox" name="collapse" id="handle@(i+1)">
                            <h2 class="handle">
                                <label for="handle@(i+1)">Question @(i+1): Correct</label>
                            </h2>
                            <div class="content">
                                <p style="margin: 0 0 1em"><strong>Question:</strong> @questions[i].Text</p>
                                <p style="margin: 0 0 1em"><strong style="color:green">Your correct answer:</strong> @correctAnswerTexts[i]</p>
                            </div>
                        </section>
                    }
                    else
                    {


                        <section class="accordion">
                            <input type="checkbox" name="collapse" id="handle@(i+1)">
                            <h2 class="handle">
                                <label for="handle@(i+1)">Question @(i+1): Incorrect</label>
                            </h2>
                            <div class="content">
                                <p style="margin: 0 0 1em"><strong>Question:</strong> @questions[i].Text</p>
                                <p style="margin: 0 0 1em"><strong style="color:red">Your answer:</strong> @selectedAnswerTexts[i]</p>
                                <p style="margin: 0 0 1em"><strong style="color:green">Correct Answer:</strong> @correctAnswerTexts[i]</p>

                            </div>
                        </section>
                    }
                }

                <br />

                <p><button class="startQuizButton" @onclick="@(() => returnToLesson())">Return to Lesson</button></p>

                <br /> <br /> 


            }

            
        }

    }

</center>





@code {

    [Parameter]
    public int CourseId { get; set; }
    [Parameter]
    public int LessonId { get; set; }
    [Parameter]
    public int QuizId { get; set; }

    public QuizDto[] quizzes;
    public QuizDto quiz;

    //Wrapped questionset of current quiz
    public QuestionPackage[] questions;

    public StudentDto student;

    //Counter indicating the current question
    public int qCounter = 0;


    //Value by which the progress bar increases
    public int progressFactor = 0;
    //Current progress of progress bar
    public int progress = 0;

    //Protocolling of users answers/results
    public bool[] results;
    public string[] selectedAnswerTexts;
    public string[] correctAnswerTexts;

    public bool inFinishedQuizzes = false;

    //UI-status-indicators
    public bool startedQuiz = false;
    public bool finishedQuiz = false;
    public String expStatus = "ExpInvisible";


    protected override async Task OnInitializedAsync()
    {
        quizzes = await Http.GetFromJsonAsync<QuizDto[]>("api/Quizzes");

        foreach (QuizDto q in quizzes)
        {
            if (q.QuizId == QuizId)
            {
                quiz = q;
            }
        }

        questions = QuestionPackage.transformQuestions(quiz.Questions);

        progressFactor = 100 / questions.Length;

        results = new bool[questions.Length];
        selectedAnswerTexts = new string[questions.Length];
        correctAnswerTexts = new string[questions.Length];

        //ToDo: Change userId to variable
        student = await Http.GetFromJsonAsync<StudentDto>($"api/Students/{1}");


        //Check at Startup Page if already completed
        foreach (FinishedQuizDto finquiz in student.FinishedQuizzes)
        {
            if (finquiz.QuizId == quiz.QuizId)
            {
                inFinishedQuizzes = true;
            }
        }

    }


    public void startQuiz()
    {
        startedQuiz = true;
    }

    public void finishQuiz()
    {
        finishedQuiz = true;
    }

    public void returnToLesson()
    {
        string uri = $"courses/{CourseId}/{LessonId}";
        NavigationManager.NavigateTo(uri);
    }


    //Interaction with Check Button
    public async void checkMe(QuestionPackage question)
    {
        if (question.check.Color == "checkReady")
        {
            if (question.checkSelection() == "correct")
            {
                question.check.Text = "Correct, Continue";
                question.check.Color = "checkCorrect";
                results[qCounter] = true;

                //Sets color of correct answer to green
                foreach (AnswerPackage ans in question.answers)
                {
                    if (ans.Correct)
                    {
                        ans.Color = "correctAnswer";

                        correctAnswerTexts[qCounter] = ans.Text;
                        selectedAnswerTexts[qCounter] = ans.Text;
                    }
                }

                //Save new correct Questions to Student's profile

                bool studentAlreadyAnsweredCorrectly = false;

                foreach (CorrectQuestionDto coquest in student.CorrectQuestions)
                {
                    if (coquest.QuestionsId == question.ID)
                    {
                        studentAlreadyAnsweredCorrectly = true;
                    }
                }

                if (!studentAlreadyAnsweredCorrectly)
                {
                    CorrectQuestionDto newCorrect = new CorrectQuestionDto();
                    newCorrect.QuestionsId = question.ID;
                    student.CorrectQuestions.Add(newCorrect);

                    expStatus = "ExpVisible";

                    await Http.PutAsJsonAsync<CorrectQuestionDto>($"api/CorrectQuestions/{student.UserId}", newCorrect);
                }




            }
            else if (question.checkSelection() == "incorrect")
            {
                question.check.Text = "Incorrect, Continue";
                question.check.Color = "checkIncorrect";
                results[qCounter] = false;

                //Set Colors for wrong and correct answer buttons
                foreach (AnswerPackage ans in question.answers)
                {
                    if (ans.Selected)
                    {
                        ans.Color = "wrongAnswer";

                        selectedAnswerTexts[qCounter] = ans.Text;
                    }

                    if (ans.Correct)
                    {
                        ans.Color = "correctAnswerWouldHaveBeen";
                        correctAnswerTexts[qCounter] = ans.Text;
                    }
                }

            }
            else if (question.checkSelection() == "error")
            {
                return;
            }
        }
        else if (question.check.Color == "checkCorrect" || question.check.Color == "checkIncorrect")
        {
            //Hide EXP-Notification for next question
            expStatus = "ExpInvisible";

            if (qCounter < questions.Length - 1)
            {
                qCounter++;
                progress += progressFactor;

            }
            else if (qCounter == questions.Length - 1)
            {
                progress = 100;

                //Delay process to finish progress bar animation
                await Task.Delay(1000).ContinueWith(t =>
                {
                    finishQuiz();

                    StateHasChanged();
                });

            }

        }
    }


    public async void saveFinishedQuizToStudent()
    {

        //Ensure that student is up-to-date (only necessary for updating finished Quizzes)
        student = await Http.GetFromJsonAsync<StudentDto>($"api/Students/{1}");

        bool alreadyFinishedQuiz = false;

        foreach (FinishedQuizDto finquiz in student.FinishedQuizzes)
        {
            if (finquiz.QuizId == quiz.QuizId)
            {
                alreadyFinishedQuiz = true;
            }
        }

        if (!alreadyFinishedQuiz)
        {

            FinishedQuizDto newFinishedQuiz = new FinishedQuizDto();
            newFinishedQuiz.QuizId = quiz.QuizId;

            await Http.PutAsJsonAsync<FinishedQuizDto>($"/api/Students/{student.UserId}/finishQuiz/{CourseId}/{LessonId}/{QuizId}", newFinishedQuiz);

        }
    }


    //UI-compliant wrapped Question
    public class QuestionPackage
    {

        public QuestionDto initialQuestion;

        public int ID { get; set; }
        public string Text { get; set; }
        public List<AnswerPackage> answers { get; set; }
        public Check check { get; set; } = new Check { Text = "Check" };


        public QuestionPackage(QuestionDto question)
        {
            this.initialQuestion = question;

            this.ID = question.QuestionId;
            this.Text = question.QuestionText;
            this.answers = AnswerPackage.transformAnswers(question.Answers);
        }


        //Wrap QuestionDto set in UI-compliant QuestionPackage set
        public static QuestionPackage[] transformQuestions(List<QuestionDto> questions)
        {
            List<QuestionPackage> newQuestions = new List<QuestionPackage>();

            foreach (QuestionDto quest in questions)
            {
                newQuestions.Add(new QuestionPackage(quest));
            }

            return newQuestions.ToArray();
        }


        //Interaction with answer buttons (Selecting and Unselecting answers and setting Check Button to ready/not ready)
        public void anythingSelected(AnswerPackage answer)
        {

            //Blocks interaction with answer buttons when the question has already been checked
            if (check.Color == "checkCorrect" || check.Color == "checkIncorrect")
            {
                return;
            }

            AnswerPackage ans = answer;

            //Check if any other answers than the clicked one are selected and unchecks them
            foreach (var a in answers)
            {
                if (a != ans && a.Selected)
                {
                    a.pressed();
                }
            }

            // (Un-) Select clicked on answer
            ans.pressed();

            bool selectionTest = false;

            //Check if any answers have been selected
            foreach (var a in answers)
            {
                if (a.Selected)
                {
                    selectionTest = true;
                }
            }

            //Set Check-Button to ready if an answer is selected
            if (selectionTest)
            {
                this.check.setReady(true);
            }
            else
            {
                this.check.setReady(false);
            }


        }


        //Check if selected answers are correct
        public string checkSelection()
        {
            AnswerPackage ans = null;
            bool selectionTest = false;

            foreach (var a in answers)
            {
                if (a.Selected)
                {
                    selectionTest = true;
                    ans = a;
                }
            }

            if (selectionTest && ans != null)
            {
                if (ans.Correct)
                {
                    return "correct";
                }
                else
                {
                    return "incorrect";
                }
            }
            else
            {
                return "error";
            }

        }
    }


    //UI-compliant wrapped Answer
    public class AnswerPackage
    {
        public int ID { get; set; }
        public string Text { get; set; }
        public bool Correct { get; set; }
        public bool Selected { get; set; } = false;
        public string Color { get; set; } = "unselected";


        public AnswerPackage(AnswerDto answer)
        {
            this.ID = answer.Id;
            this.Text = answer.AnswerText;
            this.Correct = answer.Correct;
        }

        //Set answer button color to selected or unselected
        public void pressed()
        {
            this.Selected = !Selected;

            if (this.Selected)
            {
                this.Color = "selected";
            }
            else
            {
                this.Color = "unselected";
            }

        }

        //Wrap AnswerDto set in UI-compliant AnswerPackage set
        public static List<AnswerPackage> transformAnswers(List<AnswerDto> answers)
        {
            List<AnswerPackage> newAnswers = new List<AnswerPackage>();

            foreach (AnswerDto ans in answers)
            {
                newAnswers.Add(new AnswerPackage(ans));
            }

            return newAnswers;
        }
    }


    public class Check
    {
        public string Text { get; set; }
        public bool Ready { get; set; } = false;
        public string Color { get; set; } = "checkNotReady";

        //Set Check button to (not) ready
        public void setReady(bool ready)
        {
            this.Ready = ready;

            if (ready == true)
            {
                this.Color = "checkReady";
            }
            else if (ready == false)
            {
                this.Color = "checkNotReady";
            }
        }

    }

}



